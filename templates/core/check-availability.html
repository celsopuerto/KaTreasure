{% extends 'base/base.html' %}
{% load static %}

{% block title %}
Availability | Ka Treasure Water Terraces Mountain Resort
{% endblock %}

{% block head %} 
    <link rel="stylesheet" type="text/css" href="{% static 'css/check-availability.css' %}">
{% endblock %}

{% block content %}

<section class="availability-search">
    <h1>Availability Search</h1>
    <p>Day Use: 8:00am - 5:00pm &nbsp;&nbsp;&nbsp;&nbsp; Night Use: 1:00pm - 12:00pm</p>
    <div class="search-box">
        <form id="availability-form" method="post" action="{% url 'KaTreasureApp:availability' %}">
            {% csrf_token %}
            <div class="form-group">
                <div class="form-padding">
                    <label>Available Rooms</label>
                    <div class="radio-buttons">
                        {% if time_slot == "day" %}
                            <input type="radio" id="day-use" name="time-slot" value="day" checked>
                            <label for="day-use">Day Use</label>
                            <input type="radio" id="night-use" name="time-slot" value="night">
                            <label for="night-use">Night Use</label>
                        {% elif time_slot == "night" %}
                            <input type="radio" id="day-use" name="time-slot" value="day">
                            <label for="day-use">Day Use</label>
                            <input type="radio" id="night-use" name="time-slot" value="night" checked>
                            <label for="night-use">Night Use</label>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-flex">
                    <div class="form-padding">
                        <label for="check-in">Check In</label>
                        <input type="date" id="check-in" name="check-in" value="{{ check_in }}" required>
                    </div>
                    
                    <div class="button-container">
                        <div class="form-padding">
                            <label for="room-type">Room Type</label>
                            <select id="room-type" name="room-type">
                                <option value="aircon" {% if room_type == 'aircon' %}selected{% endif %}>Aircon</option>
                                <option value="non-aircon" {% if room_type == 'non-aircon' %}selected{% endif %}>Non-Aircon</option>
                            </select>
                        </div>
                        <button type="submit" class="check-availability">Check availability</button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-flex">
                    <div class="form-padding">
                        <label>Adult<br><small>Older than 10 years</small></label>
                        <input type="hidden" id="adult-count" name="adult-count" value="{{ adults }}">
                    </div>

                    <div class="form-padding">
                        <div id="counter-padding" class="counter">
                            <button type="button" class="minus" data-type="adult">-</button>
                            <span class="count" id="adult-count-display">{{ adults }}</span>
                            <button type="button" class="plus" data-type="adult">+</button>
                        </div>
                    </div>
                    
                    <div class="form-padding" style="margin-left: 20px;">
                        <label>Children<br><small>4-10 years</small></label>
                        <input type="hidden" id="children-count" name="children-count" value="{{ child }}">
                    </div>

                    <div class="form-padding">
                        <div id="counter-padding" class="counter">
                            <button type="button" class="minus" data-type="children">-</button>
                            <span class="count" id="children-count-display">{{ child }}</span>
                            <button type="button" class="plus" data-type="children">+</button>
                        </div>
                    </div>

                </div>
            </div>
            
        </form>
    </div>
</section>

{% if filtered_data %}

<section class="availability_results">
    <div class="container">
        <div class="left-col">
            
            {% if room_count %}

            <p>{{ room_count }} Rooms</p>
            <h1>Available for you</h1>

            {% endif %}
            
            <!-- CARD -->
            
            {% for room in filtered_data %}

            <div class="house">
                <div class="house-img">
                    <img src="{% static 'img/available/image-s1.png' %}">
                </div>
                <div class="house-info">
                    <p>{{ room.type }}</p>
                    <h3>{{ room.room_id }}</h3>
                    <input type="text" name="room_id" id="room_id" value="{{ room_id }}" hidden/>   
                    <p>{{ room.description }}</p>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                    <i class="far fa-star"></i>
                    <p>Day: <strong>{% if not room.day_available %}Unavailable{% else %}Available{% endif %}</strong></p>
                    <p>Night: <strong>{% if not room.night_available %}Unavailable{% else %}Available{% endif %}</strong></p>
                    <div class="house-price">
                        <p>{{ room.max_adults }} Adults</p>
                        <p>{{ room.max_children }} Children</p>
                        <h4>₱ {{ room.price }} <span>/ session</span></h4>
                        <button class="open-card" onclick="openBookingCard('{{ room.room_id }}')">Book Room</button>
                    </div>
                </div>
            </div>

            {% endfor %}

        </div>
        <div class="right-col"></div>
    </div>
</section>

{% else %}

<section class="availability_results">
    <div class="container">
        <div class="left-col">
            <!-- <p>{{ room_count }} Rooms</p>
            <h1>Available for you</h1> -->
        </div>
    </div>
</section>

{% endif %}

<form method="POST" action="{% url 'KaTreasureApp:book-room' %}" enctype="multipart/form-data">
{% csrf_token %}
<!-- Pop-up Card -->
<div id="booking-card" class="booking-card">
    <div class="booking-card-content">
        <button class="back-btn" onclick="closeBookingCard()">← Back To Room Selection</button>
        <div class="container">
            <div class="columns">
                <div class="form-section">
                    <h2>Guest details</h2>

                        <input type="hidden" id="booking-room-id" name="room_id" value="">
                        <input type="hidden" name="check_in" id="check_in" value="{{ check_in }}"/>
                        <input type="hidden" name="adults" id="adults" value="{{ adults }}"/>
                        <input type="hdiden" name="children" id="children" value="{{ child }}"/>

                        <div class="grid-container">
                            <div class="form-group">
                                <label for="first-name">First Name *</label>
                                <input type="text" id="first-name" name="first-name" value="{{ info.first_name }}" required>
                            </div>
                            <div class="form-group">
                                <label for="last-name">Last Name *</label>
                                <input type="text" id="last-name" name="last-name" value="{{ info.last_name }}" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" name="email" value="{{ info.email }}" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone *</label>
                                <input type="tel" id="phone" name="phone" value="+63 945 257 6820" required>
                            </div>
                        </div>
                        <h3>Personal information</h3>
                        <div class="grid-container">
                            <div class="form-group">
                                <label for="address">Address *</label>
                                <input type="text" id="address" name="address" value="Suba, Argao, Cebu" required>
                            </div>
                            <div class="form-group">
                                <label for="location">Location/City *</label>
                                <input type="text" id="city" name="city" value="Cebu City" required>
                            </div>
                            <div class="form-group">
                                <label for="postal-code">Postal code (ZIP) *</label>
                                <input type="text" id="postal-code" name="postal-code" value="6021" required>
                            </div>
                            <div class="form-group">
                                <label for="purpose">Purpose of stay</label>
                                <input type="text" id="purpose" name="purpose" value="Have fun">
                            </div>
                            <div class="form-group">
                                <label for="remarks">Special remarks/requests *</label>
                                <input type="text" id="remarks" name="remarks" value="Put flowers on the bed" required>
                            </div>
                        </div>
                        <h3>Extras</h3>
                        <div class="form-group">
                            <input type="checkbox" id="shuttle-pickup" name="shuttle-pickup" value="Yes">
                            <label for="shuttle-pickup">Shuttle Pickup</label>
                        </div>
                    
                </div>
                <div class="payment-section">
                    <h2>Payment</h2>
                    <div class="room-details">
                        <img src="{% static 'img/available/image-s1.png' %}" alt="Aircon Room 2">
                        <div class="details">
                            <p>Room No: {{ room_type }} <span id="selected-room-id"></span></p>
                            <p>Max Adults: <span id="max-adults"></span></p>
                            <p>Max Children: <span id="max-children"></span></p>
                            <p><span id="description"></span></p>
                        </div>
                    </div>
                    <div class="booking-details">
                        <p>Check-in: {{ check_in }}</p>
                        <p>Shuttle Pickup: <span id="shuttle-pickup-text">No</span></p></p>
                        <p>Stay in total: <span id="room-price"></p>
                        <p>BOOKING TOTAL: ₱1,600</p>
                        <p>DEPOSIT: 50%</p>
                        <button type="button" class="deposit-btn" onclick="showPaymentModal()">Deposit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="modal" style="display: none; z-index: 20;">
    <div class="modal-content">
        <span class="closePayment" onclick="closePaymentModal()">&times;</span>
        <h2><i class="fa fa-credit-card" aria-hidden="true"></i> Payment</h2>
        <div id="payment-room-details">
            <!-- Room details will be populated here -->
        </div>
        <div class="form-group">
            <br>
            <div class="inline-details">
                <label for="qr-code">GCASH QR CODE</label>
                <input type="file" id="gcash" name="gcash" required/>
            </div>
        </div>
        <div class="form-group">
            <div class="inline-details">
                <div id="image-container">
                    <img src="{% static 'img/gcash/qr-code.png' %}" alt="QR Code" id="qr-code">
                </div>
                <div id="fullscreen-img" style="display: none;">
                    <img src="{% static 'img/gcash/qr-code.png' %}" alt="QR Code Fullscreen">
                </div>
            </div>
            <div class="agreement">
                <input type="checkbox" id="agreement" name="agreement" required>
                <label for="agreement"> By completing the booking you agree to the booking terms and privacy policy.</label>
            </div>
        </div>
        <div class="button-container">
            <button type="submit" class="confirm-btn">Confirm & Book</button>
        </div>
    </div>
</div>

</form>

<script>
    function openBookingCard(roomId) {
        fetch(`/fetch-room-data/?room_id=${roomId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const room = data.room_data;
                    document.getElementById('selected-room-id').textContent = roomId;
                    document.getElementById('booking-room-id').value = roomId;
                    document.getElementById('room_id').value = roomId;
                    document.getElementById('description').textContent = room.description;
                    document.getElementById('max-adults').textContent = room.max_adults;
                    document.getElementById('max-children').textContent = room.max_children;
                    document.getElementById('room-price').textContent = `₱${room.price}`;

                    // Populate the payment modal
                    document.getElementById('payment-room-details').innerHTML = `
                        <h1>${room.type} ${roomId}</h1>
                        <p>${room.description}</p>
                        <p>Max Adults: ${room.max_adults} adults</p>
                        <p>Max Children: ${room.max_children} children</p>
                        <hr>
                        <div class="inline-details">
                            <p><strong>Check-in:</strong> {{ check_in }}</p>
                            <p><strong>Shuttle Pickup:</strong> ${room.shuttle_pickup ? 'Yes' : 'No'}</p>
                        </div>
                        <hr>
                        <div class="inline-details">
                            <p><strong>Stay in total:</strong></p>
                            <p>₱${room.price}</p>
                        </div>
                        <div class="inline-details-down">
                            <p><strong>DOWN PAYMENT TOTAL:</strong></p>
                        </div>
                        <div class="inline-details-hr">
                            <hr>
                        </div>
                        <div class="inline-details-price">
                            <h1> ₱${room.price / 2}</h1>
                        </div>
                        <div class="inline-details-hr">
                            <hr>
                        </div>
                    `;

                    document.getElementById('booking-card').style.display = 'flex';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching room data:', error);
            });
    }

    function closeBookingCard() {
        document.getElementById('booking-card').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const shuttlePickupCheckbox = document.getElementById('shuttle-pickup');
        const shuttlePickupText = document.getElementById('shuttle-pickup-text');

        function updateShuttlePickupText() {
            shuttlePickupText.textContent = shuttlePickupCheckbox.checked ? 'Yes' : 'No';
        }

        updateShuttlePickupText();
        shuttlePickupCheckbox.addEventListener('change', updateShuttlePickupText);
    });

    function showPaymentModal() {
        document.getElementById('payment-modal').style.display = 'block';
    }

    function closePaymentModal() {
        document.getElementById('payment-modal').style.display = 'none';
    }

    function confirmBooking() {
        closePaymentModal();
        showThankYouPage();
    }

    const qrCode = document.getElementById('qr-code');
    const fullscreenImg = document.getElementById('fullscreen-img');

    qrCode.addEventListener('click', function() {
        fullscreenImg.style.display = 'flex';
    });

    fullscreenImg.addEventListener('click', function() {
        fullscreenImg.style.display = 'none';
    });
</script>

<script type="text/javascript" src="{% static 'js/check-availability.js' %}"></script>

{% endblock %}